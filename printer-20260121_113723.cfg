####################################################################################
#                         3D MELLOW /FLY-Super8-Pro                                #
####################################################################################
[include stealthburner_leds.cfg]
[include macros.cfg]
[include config_backup.cfg]
[include mainsail.cfg]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
#####################################################################
#                      Motherboard configuration                    #
#####################################################################
[mcu]                           # FLY motherboard ID
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_3B0036000B47313336323134-if00
### How to query the USB firmware ID：ls -l /dev/serial/by-id/
### Replace /dev/serial/by-id/usb-Klipper_stm32f407xx_XXXXXXXXXXXXXXXXXXXXX with the queried id
#canbus_uuid: e51d5c71a901
### method of querying the CAN firmware ID：~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
### You need to remove the serial, then remove the # in front of canbus, and add the id

#####################################################################
#                        Toohead configuration                      #
#####################################################################

[mcu sb_can_th]
serial: /dev/serial/by-id/usb-Klipper_stm32f072xb_230037000757435433353320-if00

#####################################################################
#                     cartographer configuration                    #
#####################################################################

[mcu cartographer] # See https://www.klipper3d.org/Config_Reference.html#mcu
# Remove either the serial or canbus_uuid line dependant on your setup.
serial: /dev/serial/by-id/usb-Cartographer_stm32g431xx_20002C000550315551333620-if00
#canbus_uuid: <blank>
restart_method: command # Not needed for probes using CAN.

#####################################################################
#                       Model and Acceleration                      #
#####################################################################

[force_move]
enable_force_move: true

[printer]
kinematics: corexy              # Kinematic structures are divided into Cartesian, CoreXY and hybrid_corexy etc.
max_velocity: 500  
max_accel: 6000
max_z_velocity: 30
max_z_accel: 300
square_corner_velocity: 5.0

[adxl345]
cs_pin: cartographer:PA0 # For Cartographer V4
spi_bus: spi1
# cs_pin: sb_can_th:PB12
# spi_software_sclk_pin: sb_can_th:PB13
# spi_software_mosi_pin: sb_can_th:PB15
# spi_software_miso_pin: sb_can_th:PB14
# axes_map: -y,z,-x

[resonance_tester]
accel_chip: adxl345
probe_points:
    125, 125, 20 # an example

#####################################################################
#                      Temperature monitoring                       #
#####################################################################
## When the temperature exceeds the set value, it will stop working.
[temperature_sensor FLY-Super8]   
sensor_type: temperature_mcu     # Associated MCU 
min_temp: 0                      # Minimum temperature 
max_temp: 200                    # Maximum temperature 
#--------------------------------------------------------------------
[temperature_sensor RPI]    # The temperature of the upper computer
sensor_type: temperature_host 
min_temp: 0
max_temp: 200
#--------------------------------------------------------------------
[temperature_sensor CAN_MCU_Temp]
sensor_type: temperature_mcu
sensor_mcu: sb_can_th
min_temp: 0
max_temp: 150

[temperature_sensor Driver_Temp]  # Beside the TMC2209 Chip
sensor_type: Generic 3950
sensor_pin: sb_can_th: PB1
min_temp:0
max_temp:150

[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

# [temperature_sensor Warehouse]         
## The temperature of the warehouse. （The temperature of the warehouse.）
# sensor_type: ATC Semitec 104GT-2  
# sensor_pin: PA4                   
## Analog input pin connected to the thermistor. This parameter must
# min_temp: 0 
# max_temp: 200

#####################################################################
#                        (X/Y Stepper Settings)                     # 
#####################################################################
#   B Motor ---- Motor A 
#   |                  |
#   |-----extruder-----|
#   |                  |
#   |                  |
#      Straight ahead.   
#####################################################################
#                  Toolhead Motors X/B & Y/A 		                #
#####################################################################
##  Left Extruder X/B motor (when looking at the front)
##  Connected to Driver0
##  Endstop connected to PB6
[stepper_x]
step_pin: PE6
dir_pin: PG6                          # Motion direction control pin, adding an exclamation mark (!) will reverse the direction.
enable_pin: !PG7                   
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: sb_can_th: PA2					#PA2 on T0 toolhead

position_min: 0
position_endstop: 250                 # The maximum travel (250mm-300mm-350mm) needs to be set according to your own machine.
position_max: 250                  # The maximum travel (250mm-300mm-350mm) needs to be set according to your own machine.

homing_speed: 50
homing_retract_dist: 5                # If using infinite positions, please change to 0
second_homing_speed: 5
homing_positive_dir: true
#step_pulse_duration: 0.000004

[tmc2209 stepper_x]
uart_pin: PG5
interpolate: False                   # Whether to enable 256 microstep interpolation (True for enable, False for disable).
run_current: 0.8                     # The operating current of the motor.
sense_resistor: 0.110
stealthchop_threshold: 0             # StealthChop mode will be enabled when the velocity is below the set value.

#####################################################################
#                          y Motor  (A Motor)                       #
#####################################################################
##  Right Y motor (when looking at the front)
##  Connected to Driver2
##  Endstop connected to IO3

[stepper_y]
step_pin: PE0
dir_pin: PG3
enable_pin: !PG4
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200

endstop_pin: PG12 #IO0
position_min: 0
position_endstop: 250
position_max: 250

homing_speed: 50
homing_retract_dist: 5
second_homing_speed: 5
homing_positive_dir: true
#step_pulse_duration: 0.000004

[tmc2209 stepper_y]
uart_pin: PG2
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#                      Z Stepper Settings                           #
#####################################################################
#   |----- Z1 -----|
#   |              |
#   |              |
#   |              |
#   Z0----4.30"---Z2

#####################################################################
#                        Z Stepper Settings                         #
#####################################################################
##  Front Left Z motor (when looking at the front)
##  Connected to Driver4
##  Endstop connected to IO4
[stepper_z]
step_pin: PE1
dir_pin: PF0
enable_pin: !PC15
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: probe:z_virtual_endstop

#position_endstop: 0
position_max: 250
position_min: -5

homing_speed: 5
homing_retract_dist: 0
second_homing_speed: 5
homing_positive_dir: false
#step_pulse_duration: 0.000004

[tmc2209 stepper_z]
uart_pin: PF1
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#--------------------------------------------------------------------
##  Rear Middle Z motor (when looking at the front)
##  Connected to Driver5
##  Endstop connected to IO4
[stepper_z1]
step_pin: PE15
dir_pin: PE11
enable_pin: !PF2
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 32
#step_pulse_duration: 0.000004

[tmc2209 stepper_z1]
uart_pin: PE10
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#--------------------------------------------------------------------
##  Front Right Z motor (when looking at the front)
##  Connected to Driver6
##  Endstop connected to
[stepper_z2]
step_pin: PE14
dir_pin: PE8
enable_pin: !PE9
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 32
#step_pulse_duration: 0.000004

[tmc2209 stepper_z2]
uart_pin: PE7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#   Extruder
#####################################################################

#   Connected to MOTOR_6
#   Heater - HE0
#   Thermistor - T0
[extruder]
step_pin: sb_can_th:PB3
dir_pin: sb_can_th:PA8 
enable_pin: !sb_can_th:PA15 
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
rotation_distance: 22.6789511   #Bondtech 5mm Drive Gears
##  Update Gear Ratio depending on your Extruder Type
##  Use 50:10 for Stealthburner/Clockwork 2
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
gear_ratio: 50:10
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: sb_can_th:PC15
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: sb_can_th:PA6
min_temp: 0
max_temp: 300 
max_power: 1.0
min_extrude_temp: 125
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
##  Try to keep pressure_advance below 1.0
pressure_advance: 0.05
##  Default is 0.040, leave stock
pressure_advance_smooth_time: 0.040
max_extrude_cross_section: 5000.0

##  E0 on MOTOR6
##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 extruder]
uart_pin: sb_can_th:PA10
tx_pin: sb_can_th:PA9
interpolate: false
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0
##diag_pin: sb_can_th:PB5


#####################################################################
#                         heater_bed                                # 
#####################################################################
[heater_bed]
heater_pin: PD15
sensor_type: ATC Semitec 104GT-2    # Sensor models (Generic 3950, ATC Semitec 104GT-2, PT1000)
sensor_pin:  PC1
max_power: 0.6
min_temp: 0
max_temp: 120
##Calibration command："PID_CALIBRATE HEATER=heater_bed TARGET=100"
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#                               Bed_mesh                            # 
#####################################################################
[bed_mesh]
mesh_min: 20, 21
mesh_max: 230, 209
probe_count: 21, 21
speed: 350
horizontal_move_z: 5
zero_reference_position: 125, 125
#mesh_pps: 2,2          # Additional sampling points
algorithm: bicubic     # Algorithm model
bicubic_tension: 0.2  

#####################################################################
# FANS
#####################################################################

[heater_fan hotend_fan]
pin: sb_can_th:PB0
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0

#  Print Cooling Fan - FAN0 Connector
[fan]
pin: PF8  # Super8 IN7
max_power: 1.0
kick_start_time: 0.5
# off_below: 0.10
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0
# tachometer_pin: PG10
# tachometer_ppr: 1
# tachometer_poll_interval: 0.005

##  Controller fan x2 - In E1 OUT Positon
[heater_fan controller_fan]
pin: PA0
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
heater: heater_bed
heater_temp: 50.0
fan_speed: 0.6

# [fan_generic fan0]
# pin: sb_can_th:PB6
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic fan1]
# pin: sb_can_th:PB5
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic fan2]
# pin: sb_can_th:PA4
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1

# [fan_generic ext_fan0]  # on the AUX board
# pin: sb_can_th:PB0
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1
# tachometer_pin: sb_can_th:PB10
# #tachometer_ppr:
# #tachometer_poll_interval:

# [fan_generic ext_fan1]  # on the AUX board
# pin: sb_can_th:PB7
# max_power:1.0
# shutdown_speed:0.0
# cycle_time:0.5
# hardware_pwm:false
# kick_start_time:0.10
# off_below:0.1
# tachometer_pin: sb_can_th:PA7
# #tachometer_ppr:
# #tachometer_poll_interval:

#####################################################################
#                  Idle and turn off the heated bed                 #
#####################################################################
[idle_timeout]
timeout: 1800                # Turn off the heated bed after 30 minutes of inactivity

#####################################################################
#                             PROBE                                 #
#####################################################################
[cartographer]
mcu: cartographer
x_offset: 0 # This is the offset of your probe from the nozzle tip, to the centre of the coil.
y_offset: 21 # This is the offset of your probe from the nozzle tip, to the centre of the coil.
verbose: no # For extra output

#####################################################################
#                             Zeroing                               #
#####################################################################
[safe_z_home]                
home_xy_position: 125,125     # z endstop position
speed: 300 
z_hop: 15                     # Lift height before homing

#--------------------------------------------------------------------

#[homing_override]            # Home Z-axis (if using Klicky, comment out this section)
#axes: z
#set_position_z: 0
#gcode:
#   G90
#   G0 Z5 F600
#   G28 X Y
   ## z endstop position
   ## Test a few times to ensure there are no issues, then update X and Y to your values (e.g. X157, Y305)
#   G0 X-10 Y-10 F3600
   
#   G28 Z
#   G0 Z10 F1800
   
    ##  Remove the "#" in front of the corresponding configuration based on the size of your machine:
    ##  Roughly measure the center of your bed.
#--------------------------------------------------------------------
    ##  250mm model
    #G0 X125 Y125 Z30 F3600
#--------------------------------------------------------------------   
    ##  300mm model
    #G0 X150 Y150 Z30 F3600
#--------------------------------------------------------------------
    ##  350mm model
    #G0 X175 Y175 Z30 F3600
#--------------------------------------------------------------------

#####################################################################
#                         Motor Tilt Adjustment                     #
#####################################################################
##Multiple Z stepper tilt adjustment. This feature enables independent adjustment of multiple z
[z_tilt]
## Use the Z_TILT_ADJUST command to level the heated bed
#
#z_positions:
##--------------------------------------------------------------------
## Uncomment below for 250mm build
z_positions:
   -50, 18
   125, 298
   300, 18
points:
   30, 5
   125, 195
   220, 5


##-------------------------------------------------------------------

speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

#--------------------------------------------------------------------
#####################################################################
#	                    Neopixels                                   #
#####################################################################

# [neopixel ext_leds]
# pin: sb_can_th: PC14 #on the AUX board RGB
# chain_count: 3
# color_order: GRB
# initial_RED: 0.0 #0.5
# initial_GREEN: 0.0
# initial_BLUE: 0.5 #0.5
# #initial_WHITE: 0.5 #0.5

#####################################################################
#	Voltage Monitor
#####################################################################

[adc_temperature 5V_Monitor]
temperature1: 5
voltage1: 3.0
temperature2: 4
voltage2: 2.4
temperature3: 3
voltage3: 1.8

[adc_temperature 24V_Monitor]
temperature1: 24
voltage1: 3.13
temperature2: 22
voltage2: 2.87
temperature3: 21
voltage3: 2.74

[temperature_sensor 5V_Monitor]
sensor_type: 5V_Monitor
sensor_pin: sb_can_th:PA1   #5V_MON
adc_voltage: 3.3
voltage_offset: 0

[temperature_sensor 24V_Monitor]
sensor_type: 24V_Monitor
sensor_pin: sb_can_th:PA5   #24V_MON
adc_voltage: 3.3
voltage_offset: 0

#####################################################################
#	PIN Define
#####################################################################

# On the AUX Board

# ext_IO.6: PA7
# ext_fan0: PB0
# ext_IO.5: PB10
# ext_fan1: PB7
# RGB: PC14

# On the SB_Combo Board

# IO.0 and IO.1 are located in the same connector and can be used as XY endstops, 
# and IO.2 can be used as a probe. In addition, IO.0, IO.1, and IO.2 have level 
# conversion (with pull-up resistors) and voltage selectors (5V or 24V), which can 
# be compatible with a variety of sensors. The three IOs and RGB can be used as inputs 
# or outputs, and can be configured according to your needs.

# IO.0: PA2
# IO.1: PA3   
# IO.2: PA0
# RGB: PB11

# FAN0: PB6
# FAN1: PB5
# FAN2: PA4

# Heat: PC15
# Thermistor: PA6

# Driver_EN: PA15
# Driver_DIR: PA8
# Driver_STEP: PB3
# Driver_UART: PA10
# Driver_TX: PA9
# Driver_DIAG: PB4

# spi_bus: spi2
# adxl345_cs_pin: PB12
# adxl345_spi_software_sclk_pin: PB13
# adxl345_spi_software_mosi_pin: PB15
# adxl345_spi_software_miso_pin: PB14

# CAN_RX: PB8
# CAN_TX: PB9

# 5V_Monitor: PA1
# 24V_MOnitor: PA5
# TMC_Thermistor: PB1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 30.876
#*# pid_ki = 1.176
#*# pid_kd = 202.622
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4542815662965463,1.9260285832388013,0.865409266230787,0.42124793289126955,0.33977298711058374,0.4088015466094946,-0.04790488636609054,-0.30497134447328045,0.1897983502326877,0.25082741756241334
#*# domain = 3.209998866902878e-07,3.371804805548397e-07
#*# z_offset = 0
#*# reference_temperature = 17.96
#*# software_version = 1.3.3
#*# mcu_version = Cartographer HT 5.1.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 770
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.3.3
#*# mcu_version = Cartographer HT 5.1.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.277
#*# pid_ki = 3.557
#*# pid_kd = 56.199
